import telebot
import os
import asyncio
import math
import time
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton
from config import BOT_TOKEN, ADMIN_ID, MONITORED_CHANNELS, EXPORT_DIR, update_channels, update_output
from database import *
from utils import card_pattern, get_bin_details, parse_expiry_year

bot = telebot.TeleBot(BOT_TOKEN)

# Global Client References
main_client = None
main_loop = None

# Cache for User Selections (To handle number inputs)
# Format: { user_id: { "1": "USA", "2": "UK", ... } }
user_selection_cache = {}

def set_main_client(client, loop):
    global main_client, main_loop
    main_client = client
    main_loop = loop

# --- UI HELPERS ---

def get_main_menu_keyboard():
    """Main Menu á€€á€­á€¯ Keyboard Button á€€á€¼á€®á€¸á€á€½á€±á€”á€²á€· á€•á€¼á€™á€šá€º"""
    markup = ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    markup.add(
        KeyboardButton("ğŸ“Š Dashboard"),
        KeyboardButton("âš™ï¸ Settings"),
        KeyboardButton("ğŸ“‚ File Tools"),
        KeyboardButton("ğŸ” Filter & Export"),
        KeyboardButton("ğŸ“‹ Channels"),
        KeyboardButton("âŒ Close Panel") # Optional to hide keyboard
    )
    return markup

def get_back_btn(callback_data):
    return InlineKeyboardButton("ğŸ”™ Back", callback_data=callback_data)

# --- START & MAIN MENU ---

@bot.message_handler(commands=['start'])
def send_welcome(message):
    if message.from_user.id != ADMIN_ID: return
    bot.send_message(
        message.chat.id, 
        "ğŸ‘‹ **Welcome to Pro Scraper V3**\n\nMain Menu á€€á€­á€¯ á€¡á€±á€¬á€€á€ºá€€ Keyboard á€™á€¾á€¬ á€›á€½á€±á€¸á€á€»á€šá€ºá€”á€­á€¯á€„á€ºá€•á€«á€•á€¼á€®:", 
        reply_markup=get_main_menu_keyboard(), 
        parse_mode="Markdown"
    )

@bot.message_handler(func=lambda message: message.text == "âŒ Close Panel")
def close_panel(message):
    from telebot.types import ReplyKeyboardRemove
    bot.send_message(message.chat.id, "âœ… Panel Closed. Type /start to open again.", reply_markup=ReplyKeyboardRemove())

# --- DASHBOARD (Replied via Keyboard) ---
@bot.message_handler(func=lambda message: message.text == "ğŸ“Š Dashboard")
def dashboard_view(message):
    if message.from_user.id != ADMIN_ID: return
    
    total_cards, total_bins = get_dashboard_stats()
    monitored_count = len(MONITORED_CHANNELS)
    
    msg = (
        f"ğŸ“Š **Live Dashboard**\n"
        f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        f"ğŸ’³ **Total Cards:** `{total_cards}`\n"
        f"ğŸ”¢ **Unique BINs:** `{total_bins}`\n"
        f"ğŸ“¡ **Active Channels:** `{monitored_count}`\n"
        f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        f"âš¡ Status: `Running`"
    )
    
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("ğŸ”„ Refresh Stats", callback_data="refresh_dashboard"))
    
    bot.send_message(message.chat.id, msg, reply_markup=markup, parse_mode="Markdown")

@bot.callback_query_handler(func=lambda call: call.data == "refresh_dashboard")
def refresh_dashboard(call):
    total_cards, total_bins = get_dashboard_stats()
    monitored_count = len(MONITORED_CHANNELS)
    
    msg = (
        f"ğŸ“Š **Live Dashboard**\n"
        f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        f"ğŸ’³ **Total Cards:** `{total_cards}`\n"
        f"ğŸ”¢ **Unique BINs:** `{total_bins}`\n"
        f"ğŸ“¡ **Active Channels:** `{monitored_count}`\n"
        f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        f"âš¡ Status: `Running`"
    )
    
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("ğŸ”„ Refresh Stats", callback_data="refresh_dashboard"))
    
    try:
        bot.edit_message_text(msg, call.message.chat.id, call.message.message_id, reply_markup=markup, parse_mode="Markdown")
    except: pass

# --- SETTINGS ---
@bot.message_handler(func=lambda message: message.text == "âš™ï¸ Settings")
def settings_view(message):
    if message.from_user.id != ADMIN_ID: return
    markup = InlineKeyboardMarkup(row_width=1)
    markup.add(
        InlineKeyboardButton("ğŸ“¢ Set Output Channel", callback_data="set_output"),
        InlineKeyboardButton("ğŸ—‘ Auto-Clean Expired Cards", callback_data="clean_expired")
    )
    bot.send_message(message.chat.id, "âš™ï¸ **Settings Panel**", reply_markup=markup, parse_mode="Markdown")

@bot.callback_query_handler(func=lambda call: call.data == "clean_expired")
def clean_expired_logic(call):
    deleted = delete_expired_cards()
    bot.answer_callback_query(call.id, f"ğŸ—‘ Deleted {deleted} cards!")
    bot.send_message(call.message.chat.id, f"âœ… **Cleanup Complete**\nğŸ—‘ Removed: `{deleted}` expired cards.")

# --- FILTER & EXPORT (Updated Logic) ---
@bot.message_handler(func=lambda message: message.text == "ğŸ” Filter & Export")
def filter_view(message):
    if message.from_user.id != ADMIN_ID: return
    markup = InlineKeyboardMarkup(row_width=2)
    markup.add(
        InlineKeyboardButton("ğŸŒ By Country List", callback_data="country_page_1"),
        InlineKeyboardButton("ğŸ”¢ By BIN", callback_data="filter_bin"),
        InlineKeyboardButton("ğŸ“‚ Export All Data", callback_data="export_all")
    )
    bot.send_message(message.chat.id, "ğŸ” **Select Filter Option:**", reply_markup=markup, parse_mode="Markdown")

# --- COUNTRY LIST WITH NUMBER SELECTION ---
@bot.callback_query_handler(func=lambda call: call.data.startswith("country_page_"))
def country_list_view(call):
    page = int(call.data.split("_")[2])
    per_page = 20
    
    data, total_countries = get_country_stats_paginated(page, per_page)
    total_pages = math.ceil(total_countries / per_page)
    
    # Text List Display
    msg_text = f"ğŸŒ **Top Countries (Page {page}/{total_pages})**\n"
    msg_text += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
    msg_text += "á€™á€­á€™á€­á€œá€­á€¯á€á€»á€„á€ºá€á€±á€¬ á€”á€­á€¯á€„á€ºá€„á€¶á **á€”á€¶á€•á€«á€á€ºá€…á€‰á€º** á€€á€­á€¯ Reply á€•á€¼á€”á€ºá€•á€±á€¸á€•á€«á‹\n\n"
    
    # Clear old cache for this user and build new one
    user_id = call.from_user.id
    user_selection_cache[user_id] = {}
    
    for idx, (country, flag, count) in enumerate(data):
        display_flag = flag if flag else "ğŸ³ï¸"
        list_number = idx + 1 + (page-1)*per_page
        
        # Store mapping: "1" -> "USA"
        user_selection_cache[user_id][str(list_number)] = country
        
        # Format: 1. ğŸ‡ºğŸ‡¸ USA : 500
        msg_text += f"`{list_number}.` {display_flag} **{country}** : `{count}`\n"

    # Navigation Buttons (Only Next/Prev)
    markup = InlineKeyboardMarkup(row_width=2)
    nav_btns = []
    if page > 1:
        nav_btns.append(InlineKeyboardButton("â¬…ï¸ Prev", callback_data=f"country_page_{page-1}"))
    if page < total_pages:
        nav_btns.append(InlineKeyboardButton("Next â¡ï¸", callback_data=f"country_page_{page+1}"))
    
    if nav_btns:
        markup.add(*nav_btns)
        
    # Send or Edit
    try:
        bot.edit_message_text(msg_text, call.message.chat.id, call.message.message_id, reply_markup=markup, parse_mode="Markdown")
    except:
        bot.send_message(call.message.chat.id, msg_text, reply_markup=markup, parse_mode="Markdown")

# --- HANDLE NUMBER INPUT FOR COUNTRY SELECTION ---
@bot.message_handler(func=lambda message: message.text.isdigit())
def handle_country_selection(message):
    if message.from_user.id != ADMIN_ID: return
    
    user_id = message.from_user.id
    selected_num = message.text.strip()
    
    # Check if user has a selection cache (Is looking at country list?)
    if user_id in user_selection_cache and selected_num in user_selection_cache[user_id]:
        country_name = user_selection_cache[user_id][selected_num]
        
        bot.reply_to(message, f"â³ Exporting cards for **{country_name}**...")
        
        cards = get_cards_by_country(country_name)
        send_export_file(message.chat.id, cards, f"{country_name}")
        
    else:
        # If number is sent but not in list context, ignore or handle elsewhere
        pass

# --- FILE TOOLS ---
@bot.message_handler(func=lambda message: message.text == "ğŸ“‚ File Tools")
def file_tools_view(message):
    if message.from_user.id != ADMIN_ID: return
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("ğŸ“¤ Upload Combo File", callback_data="upload_req"))
    bot.send_message(message.chat.id, "ğŸ“‚ **File Processing Tools**", reply_markup=markup, parse_mode="Markdown")

@bot.callback_query_handler(func=lambda call: call.data == "upload_req")
def upload_prompt(call):
    # FIX: Send Message á€¡á€…á€¬á€¸ Edit Message Text á€á€¯á€¶á€¸á€‘á€¬á€¸á€á€Šá€º
    try:
        msg = bot.edit_message_text(
            "ğŸ“¤ **Please send the .txt file now:**\n(Reply with a combo file)", 
            call.message.chat.id, 
            call.message.message_id
        )
    except:
        # Edit á€™á€›á€›á€„á€º (Message á€¡á€›á€™á€ºá€¸á€€á€¼á€¬á€”á€±á€›á€„á€º) á€¡á€á€…á€ºá€•á€­á€¯á€·á€™á€šá€º
        msg = bot.send_message(call.message.chat.id, "ğŸ“¤ **Please send the .txt file now:**")
        
    bot.register_next_step_handler(msg, process_upload_step)

def process_upload_step(message):
    if not message.document:
        bot.reply_to(message, "âŒ Invalid file. Please try again.")
        return
    
    # User á€–á€­á€¯á€„á€ºá€•á€­á€¯á€·á€œá€­á€¯á€€á€ºá€•á€¼á€®á€™á€­á€¯á€· Progress á€€á€­á€¯ Message á€¡á€á€…á€ºá€”á€²á€·á€•á€¼á€™á€¾á€›á€•á€«á€™á€šá€º (User message á€¡á€±á€¬á€€á€ºá€›á€±á€¬á€€á€ºá€á€½á€¬á€¸á€œá€­á€¯á€·á€•á€«)
    status_msg = bot.send_message(message.chat.id, "â³ **Initializing Upload...**")
    
    file_info = bot.get_file(message.document.file_id)
    downloaded_file = bot.download_file(file_info.file_path)
    
    temp_path = "temp_combo.txt"
    with open(temp_path, 'wb') as new_file:
        new_file.write(downloaded_file)
        
    asyncio.run_coroutine_threadsafe(
        process_bulk_upload_live(message.chat.id, status_msg.message_id, temp_path), 
        main_loop
    )
async def process_bulk_upload_live(chat_id, message_id, file_path):
    import aiohttp
    
    with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
        content = f.read()
        matches = card_pattern.findall(content)
    
    os.remove(file_path)
    
    total = len(matches)
    if total == 0:
        bot.edit_message_text("âŒ **Error:** No valid cards found.", chat_id, message_id)
        return

    added = 0
    duplicates = 0
    
    def get_progress_bar(current, total, length=10):
        percent = current / total
        filled = int(length * percent)
        bar = "â–ˆ" * filled + "â–‘" * (length - filled)
        return bar, int(percent * 100)

    async with aiohttp.ClientSession() as session:
        for i, match in enumerate(matches):
            full_card = f"{match[0].replace(' ', '').replace('-', '')}|{match[1]}|{match[2]}|{match[3] if match[3] else 'N/A'}"
            
            if check_card_exists(full_card):
                duplicates += 1
            else:
                bin_data = await get_bin_details(session, full_card)
                parts = full_card.split('|')
                year = parse_expiry_year(parts[2])
                month = parts[1]
                
                if add_card(full_card, full_card[:6], bin_data, month, year, "File Upload"):
                    added += 1
            
            if i % 10 == 0 or i == total - 1:
                bar, percent = get_progress_bar(i + 1, total)
                status_text = (
                    f"ğŸ“¤ **Processing File...**\n"
                    f"`{bar}` **{percent}%**\n\n"
                    f"ğŸ”¢ Checked: `{i+1}/{total}`\n"
                    f"âœ… Added: `{added}`\n"
                    f"â™»ï¸ Duplicates: `{duplicates}`"
                )
                try:
                    bot.edit_message_text(status_text, chat_id, message_id, parse_mode="Markdown")
                except: pass
                
            await asyncio.sleep(0.1)

    bot.edit_message_text(
        f"âœ… **Upload Complete!**\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        f"ğŸ“¥ Total Input: `{total}`\n"
        f"ğŸ†• Added: `{added}`\n"
        f"â™»ï¸ Duplicates: `{duplicates}`", 
        chat_id, message_id, parse_mode="Markdown"
    )

# --- CHANNEL MANAGER (Keyboard Menu) ---
@bot.message_handler(func=lambda message: message.text == "ğŸ“‹ Channels")
def channel_manager_view(message):
    if message.from_user.id != ADMIN_ID: return
    markup = InlineKeyboardMarkup(row_width=1)
    markup.add(
        InlineKeyboardButton("â• Add New Channel", callback_data="add_channel_menu"),
        InlineKeyboardButton("ğŸ“‹ View/Remove Channels", callback_data="list_remove_channels")
    )
    bot.send_message(message.chat.id, "ğŸ“¡ **Channel Manager**", reply_markup=markup, parse_mode="Markdown")

@bot.callback_query_handler(func=lambda call: call.data == "list_remove_channels")
def list_remove_channels(call):
    if not MONITORED_CHANNELS:
        bot.answer_callback_query(call.id, "No channels active.")
        return
        
    markup = InlineKeyboardMarkup(row_width=1)
    for cid in MONITORED_CHANNELS:
        markup.add(InlineKeyboardButton(f"ğŸ—‘ Remove ID: {cid}", callback_data=f"rem_{cid}"))
    
    bot.edit_message_text("ğŸ“‹ **Tap to Remove Channel:**", call.message.chat.id, call.message.message_id, reply_markup=markup, parse_mode="Markdown")

@bot.callback_query_handler(func=lambda call: call.data.startswith("rem_"))
def remove_channel_action(call):
    cid = int(call.data.split("_")[1])
    update_channels(cid, "remove")
    bot.answer_callback_query(call.id, "Removed!")
    list_remove_channels(call)

# --- ADD CHANNEL LOGIC ---
@bot.callback_query_handler(func=lambda call: call.data == "add_channel_menu")
def add_channel_menu(call):
    markup = InlineKeyboardMarkup(row_width=1)
    markup.add(
        InlineKeyboardButton("ğŸ”— Enter ID / Link", callback_data="add_by_link"),
        InlineKeyboardButton("ğŸ“‚ Select from Joined List", callback_data="add_from_list")
    )
    bot.edit_message_text("ğŸ“Œ **How do you want to add?**", call.message.chat.id, call.message.message_id, reply_markup=markup, parse_mode="Markdown")

@bot.callback_query_handler(func=lambda call: call.data == "add_by_link")
def add_by_link_prompt(call):
    msg = bot.send_message(call.message.chat.id, "ğŸ”— **Enter Channel/Group Link or ID:**")
    bot.register_next_step_handler(msg, process_add_link)

def process_add_link(message):
    link = message.text.strip()
    bot.send_message(message.chat.id, "â³ **Resolving Link...**")
    asyncio.run_coroutine_threadsafe(resolve_and_add_channel(message.chat.id, link), main_loop)

async def resolve_and_add_channel(chat_id, link):
    try:
        try: entity = int(link)
        except: entity = link 
        chat = await main_client.get_entity(entity)
        update_channels(chat.id, "add")
        bot.send_message(chat_id, f"âœ… **Added:** {chat.title}\nID: `{chat.id}`")
    except Exception as e:
        bot.send_message(chat_id, f"âŒ Failed: {e}")

@bot.callback_query_handler(func=lambda call: call.data == "add_from_list")
def add_from_list_init(call):
    bot.edit_message_text("â³ **Fetching your dialogs...**", call.message.chat.id, call.message.message_id)
    asyncio.run_coroutine_threadsafe(fetch_and_show_dialogs(call.message.chat.id), main_loop)

async def fetch_and_show_dialogs(chat_id):
    try:
        dialogs = await main_client.get_dialogs(limit=50)
        markup = InlineKeyboardMarkup(row_width=2)
        count = 0
        for d in dialogs:
            if d.is_group or d.is_channel:
                markup.add(InlineKeyboardButton(f"{d.title[:20]}", callback_data=f"save_id_{d.id}"))
                count += 1
        bot.send_message(chat_id, f"ğŸ“‚ **Select to Monitor:**", reply_markup=markup)
    except Exception as e:
        bot.send_message(chat_id, f"âŒ Error: {e}")

@bot.callback_query_handler(func=lambda call: call.data.startswith("save_id_"))
def save_channel_id(call):
    new_id = int(call.data.split("_")[2])
    update_channels(new_id, "add")
    bot.answer_callback_query(call.id, "âœ… Added!")
    bot.send_message(call.message.chat.id, f"âœ… Added ID `{new_id}`")

# --- UTILS ---
def send_export_file(chat_id, cards, name):
    if not cards: return
    path = os.path.join(EXPORT_DIR, f"{name}.txt")
    with open(path, "w") as f: f.write("\n".join(cards))
    with open(path, "rb") as f: bot.send_document(chat_id, f, caption=f"ğŸ“‚ {len(cards)} Cards ({name})")
    os.remove(path)

@bot.callback_query_handler(func=lambda call: call.data == "set_output")
def set_output_prompt(call):
    msg = bot.send_message(call.message.chat.id, "ğŸ“¢ **Enter Output Channel Username:**")
    bot.register_next_step_handler(msg, process_set_output)

def process_set_output(message):
    update_output(message.text)
    bot.send_message(message.chat.id, f"âœ… Output Channel set to: {message.text}")

# --- BIN FILTER ---
@bot.callback_query_handler(func=lambda call: call.data == "filter_bin")
def filter_bin_prompt(call):
    msg = bot.send_message(call.message.chat.id, "ğŸ”¢ **Enter BIN Code:**")
    bot.register_next_step_handler(msg, process_bin_lookup)

def process_bin_lookup(message):
    bin_code = message.text.strip()[:6]
    stats = get_bin_stats(bin_code)
    
    if stats and stats['count'] > 0:
        flag = stats['flag'] if stats['flag'] else "ğŸ³ï¸"
        msg = (
            f"ğŸ” **BIN Information Found**\n\n"
            f"ğŸ”¢ BIN: `{bin_code}`\n"
            f"ğŸ“Š Cards: `{stats['count']}`\n"
            f"{flag} Country: {stats['country']}\n"
            f"ğŸ¦ Bank: {stats['bank']}\n"
            f"ğŸ’  Type: {stats['type']} - {stats['level']}"
        )
        markup = InlineKeyboardMarkup()
        markup.add(InlineKeyboardButton(f"ğŸ“¥ Export {stats['count']} Cards", callback_data=f"do_export_bin_{bin_code}"))
        bot.send_message(message.chat.id, msg, reply_markup=markup, parse_mode="Markdown")
    else:
        bot.send_message(message.chat.id, f"âŒ No cards found for BIN `{bin_code}`.")

@bot.callback_query_handler(func=lambda call: call.data.startswith("do_export_bin_"))
def do_export_bin(call):
    bin_code = call.data.split("_")[3]
    cards = get_cards_by_bin(bin_code)
    send_export_file(call.message.chat.id, cards, f"BIN_{bin_code}")

@bot.callback_query_handler(func=lambda call: call.data == "export_all")
def export_all_data(call):
    bot.answer_callback_query(call.id, "Generating...")
    conn = sqlite3.connect(DB_FILE)
    c = conn.cursor()
    c.execute("SELECT full_card FROM cards")
    cards = [r[0] for r in c.fetchall()]
    conn.close()
    send_export_file(call.message.chat.id, cards, "All_Cards")

def run_bot_polling():
    bot.infinity_polling()
