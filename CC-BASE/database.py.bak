import sqlite3
from datetime import datetime
from config import DB_FILE

# ... (Previous init_db and add_card functions remain the same) ...
# check_card_exists function ကို မမေ့ပါနဲ့ (အရင်အဖြေမှာ ပေးထားပြီးသားပါ)

def init_db():
    conn = sqlite3.connect(DB_FILE, check_same_thread=False)
    c = conn.cursor()
    c.execute('''
        CREATE TABLE IF NOT EXISTS cards (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            full_card TEXT UNIQUE,
            bin TEXT,
            country TEXT,
            bank TEXT,
            type TEXT,
            level TEXT,
            brand TEXT,
            exp_month INTEGER,
            exp_year INTEGER,
            source TEXT,
            date_added TIMESTAMP
        )
    ''')
    conn.commit()
    conn.close()

def add_card(full_card, bin_code, bin_data, month, year, source):
    try:
        conn = sqlite3.connect(DB_FILE)
        c = conn.cursor()
        c.execute('''
            INSERT INTO cards (full_card, bin, country, bank, type, level, brand, exp_month, exp_year, source, date_added)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (full_card, bin_code, bin_data['country'], bin_data['bank'], bin_data['type'], 
              bin_data['level'], bin_data['brand'], int(month), int(year), source, datetime.now()))
        conn.commit()
        conn.close()
        return True
    except sqlite3.IntegrityError:
        return False
    except Exception as e:
        print(f"DB Error: {e}")
        return False

def check_card_exists(full_card):
    conn = sqlite3.connect(DB_FILE)
    c = conn.cursor()
    c.execute("SELECT id FROM cards WHERE full_card = ?", (full_card,))
    data = c.fetchone()
    conn.close()
    return data is not None

# --- NEW ANALYTICS FUNCTIONS ---

def get_bin_stats(bin_code):
    """Returns count and basic info for a BIN"""
    conn = sqlite3.connect(DB_FILE)
    c = conn.cursor()
    c.execute("SELECT COUNT(*), country, bank, type, level FROM cards WHERE bin LIKE ? GROUP BY bin LIMIT 1", (f"{bin_code}%",))
    data = c.fetchone()
    conn.close()
    if data:
        return {"count": data[0], "country": data[1], "bank": data[2], "type": data[3], "level": data[4]}
    return None

def get_cards_by_bin(bin_code):
    conn = sqlite3.connect(DB_FILE)
    c = conn.cursor()
    c.execute("SELECT full_card FROM cards WHERE bin LIKE ?", (f"{bin_code}%",))
    rows = c.fetchall()
    conn.close()
    return [r[0] for r in rows]

def get_all_countries_with_count():
    conn = sqlite3.connect(DB_FILE)
    c = conn.cursor()
    c.execute("SELECT country, COUNT(*) as count FROM cards GROUP BY country ORDER BY count DESC")
    rows = c.fetchall()
    conn.close()
    return rows # Returns list of tuples [('USA', 500), ('UK', 200)]

def get_cards_by_country(country_name):
    conn = sqlite3.connect(DB_FILE)
    c = conn.cursor()
    c.execute("SELECT full_card FROM cards WHERE country = ?", (country_name,))
    rows = c.fetchall()
    conn.close()
    return [r[0] for r in rows]

# ... (Keep get_total_count and delete_expired_cards form previous code) ...
def get_total_count():
    conn = sqlite3.connect(DB_FILE)
    c = conn.cursor()
    c.execute("SELECT COUNT(*) FROM cards")
    res = c.fetchone()[0]
    conn.close()
    return res

def delete_expired_cards():
    now = datetime.now()
    current_year = now.year
    current_month = now.month
    conn = sqlite3.connect(DB_FILE)
    c = conn.cursor()
    c.execute("DELETE FROM cards WHERE exp_year < ?", (current_year,))
    c.execute("DELETE FROM cards WHERE exp_year = ? AND exp_month < ?", (current_year, current_month))
    deleted_count = c.rowcount
    conn.commit()
    conn.close()
    return deleted_count
